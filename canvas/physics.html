<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Physics</title>
</head>
<body>
<!--    通常调用width和hieght定义大小-->
<!--    不建议css的方式。因为同时定义了分辨率大小-->
<canvas id="canvas"
        style="
        border: 1px solid #aaa;
        display: block;
        margin: 50px auto"
>
    <!--        以下在支持canvas的浏览器中被忽略-->
    当前浏览器不支持canvas，请更换浏览器再试
</canvas>

<script>
    var balls = [
        {x: 512, y: 120, r: 20, g: 1, vx: -15, vy: 0, color: "red"},
        {x: 312, y: 70, r: 20, g: 1, vx: 12, vy: 0, color: "green"},
        {x: 212, y: 90, r: 20, g: 1, vx: -8, vy: 3, color: "#205"},
        {x: 212, y: 90, r: 20, g: 1, vx: 11, vy: -5, color: "#546"},
        {x: 602, y: 110, r: 20, g: 1, vx: 12, vy: 3, color: "lightblue"},
        // {x: 500, y: 50, r: 20, g: 1, vx: 10, vy: 0, color: "#005588"},
        // {x: 42, y: 90, r: 20, g: 1, vx: 1, vy: -8, color: "#005588"},
        // {x: 333, y: 77, r: 20, g: 1, vx: -10, vy: 0, color: "#005588"}
    ]
    // var ball1 = {x: 512, y: 100, r: 20, g: 1, vx: -4, vy: 0, color: "#005588"}
    // var ball2 = {x: 512, y: 100, r: 20, g: 1, vx: -4, vy: 0, color: "#005588"}

    window.onload = function () {
        var canvas = document.getElementById('canvas')
        canvas.width = 800
        canvas.height = 500

        var context = canvas.getContext('2d')

        var startTime = new Date().getTime()
        setInterval(() => {

            render(context)
            update(context)

        }, 50)

    }

    // 图像数据的更新放在这里
    function update(ctx) {
        // var time = (new Date().getTime() - startTime) / 1000
        var scale = 0.5
        for (let i = 0; i < balls.length; i++) {
            var ball = balls[i]
            ball.x += ball.vx
            // console.log(ball.y, ball.vy)
            // console.log(ball.vy)
            if (((ball.y === ctx.canvas.height - ball.r) && Math.abs(ball.vy) < 1.75)) {
                ball.vy = 0
                // console.log(Math.abs(ball.vx))
                if (Math.abs(ball.vx) < 0.3) {
                    ball.vx = 0
                } else {
                    ball.vx +=  0.1 * ball.g * -ball.vx / Math.abs(ball.vx)
                }
            } else {
                ball.y += ball.vy
                ball.vy += ball.g
            }


            if (ball.x >= ctx.canvas.width - ball.r || ball.x <= ball.r) {
                ball.vx = -ball.vx
            }

            // console.log(ball.y, ball.vy)
            if (ball.y >= ctx.canvas.height - ball.r) {
                ball.y = ctx.canvas.height - ball.r
                // ball.vy = Math.abs(ball.vy * scale) < 0.5 ? 0 : -ball.vy * scale
                ball.vy = -ball.vy * scale
            }


            for (let j = 0; j < balls.length - 1; j++) {
                if (j === i)
                    continue
                var anotherBall = balls[j]
                var deltaX = Math.abs(ball.x - anotherBall.x)
                var deltaY = Math.abs(ball.y - anotherBall.y)
                // 小球碰撞
                if (deltaX ** 2 + deltaY ** 2 <= (ball.r + anotherBall.r) ** 2) {
                    [ball.vx ,anotherBall.vx] = [anotherBall.vx, ball.vx]
                    // ball.vx = -ball.vx
                    // anotherBall.vx = -anotherBall.vx
                    // [ball.vy ,anotherBall.vy] = [anotherBall.vy, ball.vy]
                }
            }
        }

        // console.log(balls[0].y, balls[0].vy)
    }

    // render 只用来渲染新的图像。图像数据的更新放在外面
    function render(ctx, time) {
        // 通过ctx.canvas获取画布
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)

        balls.forEach(ball => {
            ctx.fillStyle = ball.color
            ctx.beginPath()
            ctx.arc(
                // ball.x + ball.vx * time,
                // ball.y + ball.vy * time + ball.g * time ** 2 / 2,
                ball.x,
                ball.y,
                ball.r,
                0,
                Math.PI * 2)
            ctx.closePath()
            ctx.fill()
        })

    }

</script>

</body>
</html>
